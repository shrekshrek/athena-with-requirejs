/*!
 * VERSION: 0.1.0
 * DATE: 2015-09-24
 * GIT: https://github.com/shrekshrek/image-selecter
 * @author: Shrek.wang
 **/

!function(e){if("function"==typeof define&&define.amd)define(["exif","exports"],function(t,i){window.ImgSlter=e(i,t)});else if("undefined"!=typeof exports){var t=require("exif");e(exports,t)}else window.ImgSlter=e({},window.EXIF)}(function(e,t){function i(){var e=navigator.userAgent;return{ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),iosv:e.substr(e.indexOf("iPhone OS")+9,3)}}return e=function(){this.initialize.apply(this,arguments)},e.prototype={initialize:function(e){var t=e||{};this.el=t.el||function(){var e=document.createElement("INPUT");return e.type="file",e.accept="image/png,image/jpeg,image/gif",e.capture="camera",e}(),this.size=t.size||500,this.type=t.type||"jpeg",this.quality=t.quality||.7,this.handler=t.handler||function(){},this.color=t.color,this.ua=i(),this.cvs=document.createElement("canvas"),this.ctx=this.cvs.getContext("2d"),this._changeHandler=this._changeHandler.bind(this),this.el.addEventListener("change",this._changeHandler,!1)},_changeHandler:function(e){var i=this,a=e.target.files[0];if(void 0!=a){var n,c,s,r,o,h;window.URL=window.URL||window.webkitURL;var l=window.URL.createObjectURL(a),d=new Image;d.src=l,d.onload=function(){t.getData(d,function(){var e=t.getTag(this,"Orientation")||0;n=d.width,r=d.height,n>=r?(c=i.size,o=c*r/n,s=n,h=r):(o=i.size,c=o*n/r,s=r,h=n);var l,g,u;switch(e){case 3:l=c,g=o,u=180;break;case 6:l=o,g=c,u=90;break;case 8:l=o,g=c,u=270;break;default:l=c,g=o,u=0}i.cvs.width=l,i.cvs.height=g,i.ctx.clearRect(0,0,l,g),i.color&&(i.ctx.fillStyle=i.color,i.ctx.fillRect(0,0,l,g)),i.ctx.translate(l/2,g/2),i.ctx.rotate(u*Math.PI/180),s>3260||h>2440?i.ua.ios?parseInt(i.ua.iosv)>=8?i.ctx.drawImage(d,0,0,n,r,-c/2,-o/2,c,o):i.ctx.drawImage(d,0,0,n/2,r/2,-c/2,-o/2,c,o):i.ctx.drawImage(d,0,0,n,r,-c/2,-o/2,c,o):i.ctx.drawImage(d,-c/2,-o/2,c,o),i.handler.call(this,{img:i.cvs.toDataURL("image/"+i.type,i.quality),width:i.cvs.width,height:i.cvs.height}),window.URL.revokeObjectURL(a)})}}},select:function(){this.el&&this.el.click()},destroy:function(){this.el.removeEventListener("change",this._changeHandler,!1),delete this.ua,delete this.ctx,delete this.cvs,delete this.el}},e});
