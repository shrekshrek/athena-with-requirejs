/*!
 * VERSION: 0.1.0
 * DATE: 2015-09-24
 * GIT: https://github.com/shrekshrek/image-selecter
 * @author: Shrek.wang
 **/

!function(e){if("function"==typeof define&&define.amd)define(["exif","exports"],function(t,i){window.ImgSlter=e(i,t)});else if("undefined"!=typeof exports){var t=require("exif");e(exports,t)}else window.ImgSlter=e({},window.EXIF)}(function(e,t){function i(){var e=navigator.userAgent;return{ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),iosv:e.substr(e.indexOf("iPhone OS")+9,3)}}return e=function(){this.initialize.apply(this,arguments)},e.prototype={initialize:function(e){var t=e||{};this.el=t.el||function(){var e=document.createElement("INPUT");return e.type="file",e.accept="image/png,image/jpeg,image/gif",e.capture="camera",e}(),this.size=t.size||500,this.type=t.type||"jpeg",this.quality=t.quality||.7,this.handler=t.handler||function(){},this.ua=i(),this.cvs=document.createElement("canvas"),this.ctx=this.cvs.getContext("2d"),this._changeHandler=this._changeHandler.bind(this),this.el.addEventListener("change",this._changeHandler,!1)},_changeHandler:function(e){var i=this,a=e.target.files[0];if(void 0!=a){var n,c,s,r,h,o;window.URL=window.URL||window.webkitURL;var d=window.URL.createObjectURL(a),l=new Image;l.src=d,l.onload=function(){t.getData(l,function(){var e=t.getTag(this,"Orientation")||0;switch(n=l.width,r=l.height,n>=r?(c=i.size,h=c*r/n,s=n,o=r):(h=i.size,c=h*n/r,s=r,o=n),e){case 3:i.cvs.width=c,i.cvs.height=h,i.ctx.clearRect(0,0,c,h),i.ctx.translate(c/2,h/2),i.ctx.rotate(180*Math.PI/180);break;case 6:i.cvs.width=h,i.cvs.height=c,i.ctx.clearRect(0,0,h,c),i.ctx.translate(h/2,c/2),i.ctx.rotate(90*Math.PI/180);break;case 8:i.cvs.width=h,i.cvs.height=c,i.ctx.clearRect(0,0,h,c),i.ctx.translate(h/2,c/2),i.ctx.rotate(270*Math.PI/180);break;default:i.cvs.width=c,i.cvs.height=h,i.ctx.clearRect(0,0,c,h),i.ctx.translate(c/2,h/2)}s>3260||o>2440?i.ua.ios?parseInt(i.ua.iosv)>=8?i.ctx.drawImage(l,0,0,n,r,-c/2,-h/2,c,h):i.ctx.drawImage(l,0,0,n/2,r/2,-c/2,-h/2,c,h):i.ctx.drawImage(l,0,0,n,r,-c/2,-h/2,c,h):i.ctx.drawImage(l,-c/2,-h/2,c,h),i.handler.call(this,{img:i.cvs.toDataURL("image/"+i.type,i.quality),width:i.cvs.width,height:i.cvs.height}),window.URL.revokeObjectURL(a)})}}},select:function(){this.el&&this.el.click()},destroy:function(){this.el.removeEventListener("change",this._changeHandler,!1),delete this.ua,delete this.ctx,delete this.cvs,delete this.el}},e});
