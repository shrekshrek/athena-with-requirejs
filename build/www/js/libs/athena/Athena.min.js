/*!
 * VERSION: 2.1.0
 * DATE: 2014-11-20
 * GIT:https://github.com/shrekshrek/athenaframework
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t,e){if("function"==typeof define&&define.amd)define(["underscore","jquery","backbone","exports"],function(i,s,a,n){t.Athena=e(t,n,i,a,s)});else if("undefined"!=typeof exports){var i=require("underscore"),s=require("backbone");e(t,exports,i,s)}else t.Athena=e(t,{},t._,t.Backbone,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(t,e,i,s,a){{var n=t.Athena,h=[],o=(h.push,h.slice);h.splice}e.VERSION="2.0.0",e.noConflict=function(){return t.Athena=n,this},i.extend(e,{PRELOAD_START:"preloadStart",PRELOAD_PROGRESS:"preloadProgress",PRELOAD_COMPLETE:"preloadComplete",TRANSITION_IN:"transitionIn",TRANSITION_IN_COMPLETE:"transitionInComplete",TRANSITION_OUT:"transitionOut",TRANSITION_OUT_COMPLETE:"transitionOutComplete",PRELOAD:"preload",TOP:"top",MIDDLE:"middle",BOTTOM:"bottom",NORMAL:"normal",REVERSE:"reverse",CROSS:"cross",FLOW_START:"flowStart",FLOW_COMPLETE:"flowComplete",WINDOW_RESIZE:"windowResize",PRELOAD_PREPARE:"preloadPrepare"}),i.extend(e,s.Events,{$body:null,$stage:null,$window:null,$document:null,_preloadFast:null,_flow:null,_isFlowing:!1,_isFullScreen:!1,_windowRect:{width:0,height:0},_windowRectMin:{width:1,height:1},_stageRect:{width:0,height:0},_depths:[1500,1e3,500,0],_curPages:null,_tempPages:null,_actionQueue:null,_preloader:null,_tempData:null,_tempFlowIndex:null,_tempPreloadIndex:null,_tempLoadedProgress:null,init:function(t){var e=this;this.$stage=t?t:a("body"),this.$body=a("body"),this.$window=a(window),this.$document=a(document),this._preloadFast=!1,this._flow=this.NORMAL,this._curPages={},this._tempPages={},this._actionQueue=[],this.$window.resize(function(){e.resize()}),this.resize()},pageOn:function(t){if(!this.$stage)throw"athena havn't stage!!!";if(t=this._checkData(t),this._actionQueue.length){var e=this._actionQueue[this._actionQueue.length-1];if("on"==e.action&&e.data==t)return}this._actionQueue.push({action:"on",data:t}),this._isFlowing||this._playQueue()},pageTo:function(t){this.pageOn(t)},pageOff:function(t){if(!this.$stage)throw"athena havn't stage!!!";if(t=this._checkData(t),this._actionQueue.length){var e=this._actionQueue[this._actionQueue.length-1];if("off"==e.action&&e.data==t)return}this._actionQueue.push({action:"off",data:t}),this._isFlowing||this._playQueue()},_playQueue:function(){var t=this;if(this._actionQueue.length>=1){var e=this._actionQueue.shift();switch(this._tempData=e.data,this._isFlowing=!0,e.action){case"on":this._tempFlowIndex=0,this._tempPreloadIndex=0,i.isArray(this._tempData)?(this._tempLoadedProgress={},i.each(this._tempData,function(e){t._flowIn(e)})):this._flowIn(this._tempData),t.trigger(t.FLOW_START,{data:this._tempData});break;case"off":var e={};if(i.isArray(this._tempData)){var s=!0;i.each(this._tempData,function(i){e=i.data?i.data:i;var a=t._curPages[e.depth];a||(s=!1)}),s?i.each(this._tempData,function(i){e=i.data?i.data:i;var s=t._curPages[e.depth];t.listenToOnce(s,t.TRANSITION_OUT_COMPLETE,function(){t._flowOutComplete(e)}),s.transitionOut()}):(this._tempData=null,this._isFlowing=!1)}else{e.depth=i.isNumber(this._tempData)?this._tempData:t._checkDepth(i.isString(this._tempData)?this._tempData:this._tempData.data?this._tempData.data.depth:this._tempData.depth);var a=t._curPages[e.depth];a?(t.listenToOnce(a,t.TRANSITION_OUT_COMPLETE,function(){t._flowOutComplete(e)}),a.transitionOut()):(this._tempData=null,this._isFlowing=!1)}}}else this._tempData=null,this._isFlowing=!1},_checkData:function(t){if(!t)throw"page data is undefined!";var e=this;if(i.isArray(t)){var s=[];return i.each(t,function(t){if(!t)throw"page data is undefined!";var a=t.data?t.data:t;if(!a.view)throw"each page data has wrong!!! must has 'data.view'";a.depth=e._checkDepth(a.depth);var n=!0;i.each(s,function(t){a.depth===t.depth&&(n=!1)}),n&&s.push(t)}),s}var a=t.data?t.data:t;if(!a.view)throw"each page data has wrong!!! must has 'data.view'";return a.depth=e._checkDepth(a.depth),t},calcDepth:function(t){return this._checkDepth(t)},_checkDepth:function(t){var e=this._depths[2];if(i.isString(t)){t=t.toLowerCase();var s="",a=0,n=t.indexOf("+"),h=t.indexOf("-"),o=Math.max(n,h),r=Math.min(n,h),l=0;switch(a=r>=0?r:o,a>0?(e=t.substring(0,a),s=t.substring(a,a+1),l=parseInt(t.substring(a+1))):e=t,e){case this.PRELOAD:e=this._depths[0];break;case this.TOP:e=this._depths[1];break;case this.MIDDLE:e=this._depths[2];break;case this.BOTTOM:e=this._depths[3]}switch(s){case"+":e+=l;break;case"-":e-=l}}return i.isNumber(t)&&(e=Math.floor(t)),e},_flowIn:function(t){var e=this,i=t.data?t.data:t,s=this._curPages[i.depth],a=(this._tempPages[i.depth],i.flow?i.flow:this._flow);switch(a){case this.NORMAL:s?(this.listenToOnce(s,this.TRANSITION_OUT_COMPLETE,function(){e._flowInComplete(t)}),s.transitionOut()):this._flowInComplete(t);break;case this.PRELOAD:case this.REVERSE:case this.CROSS:this._preloaderOn(),require([i.view],function(s){e._tempPage=new s(t.data?t:{data:t}),e._tempPages[i.depth]=e._tempPage,t.el||e.$stage.append(e._tempPage.el),e._tempPage.init(),e._initPreloader(t),e.listenToOnce(e._tempPage,e.PRELOAD_COMPLETE,function(){e._pageLoadComplete(t)}),e._tempPage.preload(e._preloadFast||"true"===i.fast)})}},_flowInComplete:function(t){var e=this,i=t.data?t.data:t,s=this._curPages[i.depth],a=this._tempPages[i.depth],n=i.flow?i.flow:this._flow;switch(n){case this.NORMAL:this._preloaderOn(),require([i.view],function(s){e._tempPage=new s(t.data?t:{data:t}),e._tempPages[i.depth]=e._tempPage,t.el||e.$stage.append(e._tempPage.el),e._tempPage.init(),e._initPreloader(t),e.listenToOnce(e._tempPage,e.PRELOAD_COMPLETE,function(){e._pageLoadComplete(t)}),e._tempPage.preload(e._preloadFast||"true"===i.fast)});break;case this.PRELOAD:s?(this.listenToOnce(s,this.TRANSITION_OUT_COMPLETE,function(){e._flowOut(t)}),s.transitionOut()):this._flowOut(t);break;case this.REVERSE:this.listenToOnce(a,this.TRANSITION_IN_COMPLETE,function(){e._flowOut(t)}),a.transitionIn();break;case this.CROSS:s&&s.transitionOut(),this._flowOut(t)}},_flowOut:function(t){var e=this,i=t.data?t.data:t,s=this._curPages[i.depth],a=this._tempPages[i.depth],n=i.flow?i.flow:this._flow;switch(n){case this.NORMAL:this.listenToOnce(a,this.TRANSITION_IN_COMPLETE,function(){e._flowOutComplete(t)}),a.transitionIn();break;case this.PRELOAD:this.listenToOnce(a,this.TRANSITION_IN_COMPLETE,function(){e._flowOutComplete(t)}),a.transitionIn();break;case this.REVERSE:s?(this.listenToOnce(s,this.TRANSITION_OUT_COMPLETE,function(){e._flowOutComplete(t)}),s.transitionOut()):this._flowOutComplete(t);break;case this.CROSS:this.listenToOnce(a,this.TRANSITION_IN_COMPLETE,function(){e._flowOutComplete(t)}),a.transitionIn()}},_flowOutComplete:function(t){{var e=this,s=t.data?t.data:t,a=this._curPages[s.depth],n=this._tempPages[s.depth];s.flow?s.flow:this._flow}a&&delete this._curPages[s.depth],n&&(this._curPages[s.depth]=n,delete this._tempPages[s.depth]),s.routing&&(document.title=s.routing),i.isArray(this._tempData)?(this._tempFlowIndex++,this._tempFlowIndex>=this._tempData.length&&(e.trigger(e.FLOW_COMPLETE,{data:this._tempData}),this._playQueue())):(e.trigger(e.FLOW_COMPLETE,{data:this._tempData}),this._playQueue())},_pageLoadComplete:function(t){var e=this,s=t.data?t.data:t,a=s.flow?s.flow:this._flow;if(i.isArray(this._tempData))this._tempFlowIndex++,this._tempFlowIndex>=this._tempData.length&&(this._tempFlowIndex=0,i.each(e._tempData,function(t){switch(a){case e.NORMAL:e._flowOut(t);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:e._flowInComplete(t)}}));else switch(a){case e.NORMAL:e._flowOut(t);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:e._flowInComplete(t)}},preloader:function(t){var e=this;if(t){if(!this.$stage)throw"athena havn't stage!!!";null!==this._preloader&&(this._preloader.destroy(),this._preloader=null);var i=t.data?t.data:t;if(i.depth=this._checkDepth(this.PRELOAD),""===i.view)throw"preloader must have data.view!!!";return require([i.view],function(i){e._preloader=new i(t.data?t:{data:t}),e.$stage.append(e._preloader.el),e._preloader.init(),e.trigger(e.PRELOAD_PREPARE)}),this._preloader}return this._preloader},_initPreloader:function(t){if(null!==this._preloader){var e=t.data?t.data:t,i=this._tempPages[e.depth];this.listenTo(i,this.PRELOAD_PROGRESS,this._preloaderProgress),this.listenTo(i,this.PRELOAD_COMPLETE,this._preloaderOff)}},_clearPreloader:function(t){if(null!==this._preloader){var e=t.data?t.data:t,i=this._tempPages[e.depth];this.stopListening(i,this.PRELOAD_PROGRESS,this._preloaderProgress),this.stopListening(i,this.PRELOAD_COMPLETE,this._preloaderOff)}},_preloaderOn:function(){null!==this._preloader&&(i.isArray(this._tempData)?(this._tempPreloadIndex++,this._tempPreloadIndex>=this._tempData.length&&(this._tempPreloadIndex=0,this._preloader.transitionIn())):this._preloader.transitionIn())},_preloaderProgress:function(t){var e=this;if(null!==this._preloader)if(i.isArray(this._tempData)){var s=0;this._tempLoadedProgress[t.data.depth]=t.progress,i.each(this._tempLoadedProgress,function(t){t&&(s+=t/e._tempData.length)}),this._preloader.progress({progress:s})}else this._preloader.progress(t)},_preloaderOff:function(t){null!==this._preloader&&(this._clearPreloader(t.data),i.isArray(this._tempData)?(this._tempPreloadIndex++,this._tempPreloadIndex>=this._tempData.length&&(this._tempPreloadIndex=0,this._preloader.transitionOut())):this._preloader.transitionOut())},getPage:function(t){var e=null;return i.each(this._tempPages,function(i){i.data===t&&(e=i)}),e?e:(i.each(this._curPages,function(i){i.data===t&&(e=i)}),e)},getPageAt:function(t){var e=this._depths[2];t&&(e=this._checkDepth(t));var i=this._tempPages[e];if(i)return i;var i=this._curPages[e];return i},fullScreen:function(t){if(!this.$stage)throw"athena havn't stage!!!";if(t){if(!i.isBoolean(t))throw"setFullScreen params must be bool!!!";this._isFullScreen=t,this.resize()}return this._isFullScreen},preloadFast:function(t){return t&&(this._preloadFast=t),this._preloadFast},isFlowing:function(){return _isFlowing},windowRect:function(){if(!this.$stage)throw"athena havn't stage!!!";return this._windowRect},windowRectMin:function(t){if(!this.$stage)throw"athena havn't stage!!!";return t&&(t.width&&(this._windowRectMin.width=t.width),t.height&&(this._windowRectMin.height=t.height),this.resize()),this._windowRectMin},stageRect:function(){if(!this.$stage)throw"athena havn't stage!!!";return this._stageRect},flow:function(t){if(!this.$stage)throw"athena havn't stage!!!";if(t)switch(t=t.toLowerCase()){case this.NORMAL:case this.PRELOAD:case this.REVERSE:case this.CROSS:this._flow=t}return this._flow||(this._flow=this.NORMAL),this._flow},resize:function(){if(!this.$stage)throw"athena havn't stage!!!";this._windowRect.width=this.$window.width(),this._windowRect.height=this.$window.height(),this._isFullScreen?(this._windowRect.width<this._windowRectMin.width?this.$body.css("overflow-x","auto"):this.$body.css("overflow-x","hidden"),this._windowRect.height<this._windowRectMin.height?this.$body.css("overflow-y","auto"):this.$body.css("overflow-y","hidden"),this._windowRect.width=this.$window.width(),this._windowRect.height=this.$window.height(),this._stageRect.width=Math.max(this._windowRect.width,this._windowRectMin.width),this._stageRect.height=Math.max(this._windowRect.height,this._windowRectMin.height),this.$stage.width(this._stageRect.width),this.$stage.height(this._stageRect.height)):(this.$body.css("overflow","auto"),this._windowRect.width=this.$window.width(),this._windowRect.height=this.$window.height(),this._stageRect.width=this.$document.width(),this._stageRect.height=this.$document.height()),this.trigger(this.WINDOW_RESIZE)}}),e.api={};var r=["init","pageTo","pageOn","pageOff","calcDepth","preloader","getPage","getPageAt","fullScreen","preloadFast","isFlowing","windowRect","windowRectMin","stageRect","flow","resize","on","once","off","trigger","listenTo","listenToOnce","stopListening"];return i.each(r,function(t){e.api[t]=function(){var i=o.call(arguments);return e[t].apply(e,i)}}),e.view={},e.view.BaseView=s.View.extend({template:null,parent:null,children:null,args:null,_isInited:null,events:{},initialize:function(t){this.children=[],t&&(this.args=t,t.template&&(this.template=t.template,this.render()))},init:function(){this._isInited||(this._isInited=!0)},destroy:function(){this.parent=null,i.each(this.children,function(t){t.destroy()}),this.children=null,this.remove()},render:function(){this.template&&this.$el.html(this.template)},resize:function(){i.each(this.children,function(t){t.resize()})},addChild:function(t,e){i.each(this.children,function(t){}),t.parent=this,this.children.push(t),e&&(e.append(t.el),t.init())},removeChild:function(t){i.each(this.children,function(e,i){return i===t?(this.children.splice(e,1),void t.destroy()):void 0})}}),e.view.BaseBtn=e.view.BaseView.extend({MOUSE_OVER:"mouseover",MOUSE_OUT:"mouseout",CLICK:"click",_isMouseOver:null,_isSelected:null,_isEnable:null,init:function(){e.view.BaseBtn.__super__.init.apply(this),this._isMouseOver=!1,this._isSelected=!1,this._isEnable=!1,this.enable(!0)},destroy:function(){this.enable(!1),e.view.BaseBtn.__super__.destroy.apply(this)},mouseOverHandler:function(){},mouseOutHandler:function(){},clickHandler:function(){},selected:function(t){t!==this._isSelected&&(t?(this.mouseOverHandler(),this._isSelected=t):(this._isSelected=t,this.mouseOutHandler()))},enable:function(t){if(t!==this._isEnable){var e=this;t?(this.$el.css("cursor","pointer"),this.$el.on("mouseenter",function(t){return e._isMouseOver=!0,e.trigger(e.MOUSE_OVER),e.mouseOverHandler(t),!1}),this.$el.on("mouseleave",function(t){return e._isMouseOver=!1,e.trigger(e.MOUSE_OUT),e.mouseOutHandler(t),!1}),this.$el.on("click",function(t){return e.trigger(e.CLICK),e.clickHandler(t),!1})):(this.$el.css("cursor","auto"),this.$el.off("mouseenter"),this.$el.off("mouseleave"),this.$el.off("click")),this._isEnable=t}}}),e.view.BasePage=e.view.BaseView.extend({_loadMax:null,_loaded:null,data:null,initialize:function(t){e.view.BasePage.__super__.initialize.apply(this,[t]);this.data=t.data,this.$el.css({"z-index":this.data.depth});var s=[],n=this.data.assets&&i.isArray(this.data.assets)?this.data.assets:[];i.each(n,function(t){s.push(a(new Image).attr({src:t})[0].src)}),this.data.assets=s},init:function(t){e.view.BasePage.__super__.init.apply(this,[t]),this.listenTo(e,e.WINDOW_RESIZE,function(){this.resize()})},destroy:function(){e.view.BasePage.__super__.destroy.apply(this)},preload:function(t){if(this.trigger(e.PRELOAD_START,{data:this.data}),t)return void this.completeHandle();var s=this,n=i.without(i.pluck(this.$el.find("img"),"src"),"").concat(this.data.assets);this._loadMax=n.length,this._loaded=0,0===this._loadMax?(this.progressHandle(1),this.completeHandle()):i.each(n,function(t){a(new Image).load(function(){s._assetLoadComplete()}).error(function(){s._assetLoadComplete()}).attr("src",t)})},_assetLoadComplete:function(){this._loaded++,this.progressHandle(this._loaded/this._loadMax),this._loaded>=this._loadMax&&this.completeHandle()},progressHandle:function(t){this.trigger(e.PRELOAD_PROGRESS,{data:this.data,progress:t})},completeHandle:function(){this.trigger(e.PRELOAD_COMPLETE,{data:this.data})},transitionIn:function(){this.resize(),this.trigger(e.TRANSITION_IN,{data:this.data})},transitionInComplete:function(){this.trigger(e.TRANSITION_IN_COMPLETE,{data:this.data})},transitionOut:function(){this.trigger(e.TRANSITION_OUT,{data:this.data})},transitionOutComplete:function(){this.destroy(),this.trigger(e.TRANSITION_OUT_COMPLETE,{data:this.data})}}),e});
