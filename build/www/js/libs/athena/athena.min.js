/*!
 * VERSION: 2.0.0
 * DATE: 2016-03-15
 * GIT:https://github.com/shrekshrek/athena-with-requirejs
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["bone","jquery","exports"],function(i,n,s){e.Athena=t(e,s,i,n)});else if("undefined"!=typeof exports){var i=require("bone"),n=require("jquery");t(e,exports,i,n)}else e.Athena=t(e,{},e.Bone,e.jQuery||e.Zepto||e.ender||e.$)}(function(t,e,i,n){function s(t,e){if(void 0===t.length)e.call(t,0,t);else for(var i=t.length,n=0;i>n;n++)e.call(t[n],n,t[n])}function a(t,e){var i=!1;if(D.actionQueue.length){var n=D.actionQueue[D.actionQueue.length-1];s(e,function(e,s){n.action==t&&n.data==s&&(i=!0)})}return i}function r(t){if(!t)throw"page data is undefined!";var e=[];return s(t,function(t,i){"number"==typeof i?i=E[i]:"string"==typeof i&&(i=E[o(i)]);var n=i.data||i;if(!n.depth)throw"page data has wrong!!! must has 'data.depth'";n.depth=o(n.depth),e.push(n)}),e}function o(t){var i=g[2];switch(typeof t){case"string":t=t.toLowerCase();var n="",s=0,a=Math.max(t.indexOf("+"),t.indexOf("-"));switch(a>0?(i=t.substring(0,a),n=t.substring(a,a+1),s=parseInt(t.substring(a+1))):i=t,i){case e.PRELOAD:i=g[0];break;case e.TOP:i=g[1];break;case e.MIDDLE:i=g[2];break;case e.BOTTOM:i=g[3]}switch(n){case"+":i+=s;break;case"-":i-=s}break;case"number":i=Math.floor(t)}return i}i.extend(e,i.Events,{PRELOAD_START:"preloadStart",PRELOAD_PROGRESS:"preloadProgress",PRELOAD_COMPLETE:"preloadComplete",BACKLOAD_COMPLETE:"backloadComplete",TRANSITION_IN:"transitionIn",TRANSITION_IN_COMPLETE:"transitionInComplete",TRANSITION_OUT:"transitionOut",TRANSITION_OUT_COMPLETE:"transitionOutComplete",PRELOAD:"preload",TOP:"top",MIDDLE:"middle",BOTTOM:"bottom",NORMAL:"normal",REVERSE:"reverse",CROSS:"cross",FLOW_START:"flowStart",FLOW_COMPLETE:"flowComplete",WINDOW_RESIZE:"windowResize",PRELOAD_PREPARE:"preloadPrepare"});var h,u,c,l=e.NORMAL,d=!1,f={width:0,height:0},O={width:0,height:0},p={width:1,height:1},g=[1500,1e3,500,0],E={},w={},T={},R={},I=null,L=!1,P=!1,D=i.extend({},i.Events,{isFlowing:!1,actionQueue:[],curDatas:null,curIndex:0,curMax:0,pageIn:function(t){this.actionQueue.push({action:"on",data:t}),this.isFlowing||this.playQueue()},pageOut:function(t){this.actionQueue.push({action:"off",data:t}),this.isFlowing||this.playQueue()},playQueue:function(){var t=this;if(0!=this.actionQueue.length){var i=this.actionQueue.shift();switch(this.curDatas=i.data,this.isFlowing=!0,this.curIndex=0,this.curMax=this.curDatas.length,i.action){case"on":s(this.curDatas,function(t,e){D.flowIn(e)});break;case"off":s(this.curDatas,function(i,n){var s=E[n.depth];t.listenToOnce(s,e.TRANSITION_OUT_COMPLETE,function(){D.flowOutComplete(n)}),s.transitionOut()})}e.trigger(e.FLOW_START,this.curDatas)}else this.curDatas=null,this.isFlowing=!1},flowIn:function(t){var i=E[t.depth],n=t.flow||l;switch(n){case e.NORMAL:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){D.flowInComplete(t)}),i.transitionOut()):this.flowInComplete(t);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:this.curIndex++,this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(v,e.PRELOAD_COMPLETE,function(){s(this.curDatas,function(t,e){D.flowInComplete(e)})}),v.load(this.curDatas))}},flowInComplete:function(t){var i=E[t.depth],n=w[t.depth],a=t.flow||l;switch(a){case e.NORMAL:this.curIndex++,this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(v,e.PRELOAD_COMPLETE,function(){s(this.curDatas,function(t,e){D.flowOut(e)})}),v.load(this.curDatas));break;case e.PRELOAD:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){D.flowOut(t)}),i.transitionOut()):this.flowOut(t);break;case e.REVERSE:this.listenToOnce(n,e.TRANSITION_IN_COMPLETE,function(){D.flowOut(t)}),n.transitionIn();break;case e.CROSS:i&&i.transitionOut(),this.flowOut(t)}},flowOut:function(t){var i=E[t.depth],n=w[t.depth],s=t.flow||l;switch(s){case e.NORMAL:case e.PRELOAD:case e.CROSS:this.listenToOnce(n,e.TRANSITION_IN_COMPLETE,function(){D.flowOutComplete(t)}),n.transitionIn();break;case e.REVERSE:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){D.flowOutComplete(t)}),i.transitionOut()):this.flowOutComplete(t)}},flowOutComplete:function(t){var i=E[t.depth],n=w[t.depth];i&&delete E[t.depth],n&&(E[t.depth]=n,delete w[t.depth]),t.routing&&(document.title=t.routing),this.curIndex++,this.curIndex>=this.curMax&&(e.trigger(e.FLOW_COMPLETE,this.curDatas),this.playQueue())}}),v=i.extend({},i.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length;var i=this;I?P?(this.listenToOnce(I,e.TRANSITION_IN_COMPLETE,function(){i.preload(t)}),I.transitionIn()):(I.transitionIn(),this.preload(t)):this.preload(t)},preload:function(t){var e=this;s(t,function(t,i){var n=i.depth;if(void 0!=R[n]){A.clearListener(i);var s=R[n];T[n]=s,delete R[n],1!=s._progress?e.initListener(i):e.complete(i)}else require([i.view],function(t){var e=new t({data:i}),n=i;T[n.depth]=e,h.append(e.el),e.init(),v.initListener(n),e.preload(L||"true"===n.fast)})})},initListener:function(t){var i=T[t.depth];this.listenTo(i,e.PRELOAD_PROGRESS,this.progress),this.listenTo(i,e.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var i=T[t.depth];this.stopListening(i,e.PRELOAD_PROGRESS,this.progress),this.stopListening(i,e.PRELOAD_COMPLETE,this.complete)},progress:function(){var t=this,e=0;s(this.curDatas,function(i,n){var s=T[n.depth];s&&(e+=s._progress/t.curMax)}),I&&I.progress({progress:e})},complete:function(t){this.clearListener(t),this.curIndex++,this.curIndex>=this.curMax&&(I&&I.transitionOut(),s(this.curDatas,function(t,e){w[e.depth]=T[e.depth],delete T[e.depth]}),this.curDatas=null,this.trigger(e.PRELOAD_COMPLETE),e.trigger(e.PRELOAD_COMPLETE,this.curDatas))}}),A=i.extend({},i.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){if(this.curDatas)throw"backload is loading!!!";this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length,s(t,function(t,e){require([e.view],function(t){var i=new t({data:e}),n=e;R[n.depth]=i,h.append(i.el),i.init(),A.initListener(n),i.preload(L||"true"===n.fast)})})},initListener:function(t){var i=R[t.depth];this.listenTo(i,e.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var i=R[t.depth];this.stopListening(i,e.PRELOAD_COMPLETE,this.complete)},complete:function(t){this.clearListener(t),this.curIndex++,this.curIndex>=this.curMax&&(this.curDatas=null,this.trigger(e.PRELOAD_COMPLETE),e.trigger(e.BACKLOAD_COMPLETE,this.curDatas))}});return i.extend(e,{init:function(t){h=t||n("body"),u=n(window),c=n(document),E={},w={},T={},u.resize(function(){e.resize()}),this.resize()},preload:function(t){var e=r(t);A.load(e)},pageTo:function(t){this.pageOn(t)},pageOn:function(t){if(!h)throw"athena havn't stage, must be init!!!";var e=r(t);a("on",e)||D.pageIn(e)},pageOff:function(t){if(!h)throw"athena havn't stage, must be init!!!";var e=r(t);a("off",e)||D.pageOut(e)},calcDepth:function(t){return o(t)},preloader:function(t){if(t){if(!h)throw"athena havn't stage!!!";I&&(I.destroy(),I=null);var i=t.data?t:{data:t};return i.data.depth=o(e.PRELOAD),require([i.data.view],function(t){I=new t(i),h.append(I.el),I.init(),e.trigger(e.PRELOAD_PREPARE)}),I}return I},getPage:function(t){var e=[w,E,T,R];for(var i in e)for(var n in e[i])if(e[i][n].data===t)return e[i][n]},getPageAt:function(t){var e=t?o(t):g[2];return w[e]||E[e]||T[e]||R[e]},fullScreen:function(t){if(t){if("boolean"!=typeof t)throw"setFullScreen params must be bool!!!";d=t,this.resize()}return d},preloadFast:function(t){if(t){if("boolean"!=typeof t)throw"preloadFast params must be bool!!!";L=t}return L},preloadMustIn:function(t){if(t){if("boolean"!=typeof t)throw"preloadMustIn params must be bool!!!";P=t}return P},isFlowing:function(){return D.isFlowing},windowRect:function(){return O},windowRectMin:function(t){return t&&(p.width=t.width||p.width,p.height=t.height||p.height),p},stageRect:function(){return f},flow:function(t){var i=l;if(t)switch(t=t.toLowerCase()){case e.NORMAL:case e.PRELOAD:case e.REVERSE:case e.CROSS:i=t}return l=i},resize:function(){O.width=u.width(),O.height=u.height(),d?(O.width<p.width?h.css("overflow-x","auto"):h.css("overflow-x","hidden"),O.height<p.height?h.css("overflow-y","auto"):h.css("overflow-y","hidden"),O.width=u.width(),O.height=u.height(),f.width=Math.max(O.width,p.width),f.height=Math.max(O.height,p.height),h.width(f.width),h.height(f.height)):(h.css("overflow","auto"),O.width=u.width(),O.height=u.height(),f.width=c.width(),f.height=c.height()),e.trigger(e.WINDOW_RESIZE)}}),e.Page=i.View.extend({_progress:null,data:null,template:null,initialize:function(t){this.data=t.data,this._progress=0,t.template&&(this.template=t.template,this.render()),this.$el.css({"z-index":this.data.depth})},render:function(){this.$el.html(this.template)},init:function(){this.listenTo(e,e.WINDOW_RESIZE,function(){this.resize()})},resize:function(){},destroy:function(){this.data=null,this.remove()},preload:function(t){function i(){c++,a._progress=c/u,a.progressHandle(),c>=u&&a.completeHandle()}if(this.trigger(e.PRELOAD_START,this.data),t)return void this.completeHandle();for(var a=this,r=this.$el.find("img"),o=[],h=r.length-1;h>=0;h--)r[h].src&&""!==r[h].src&&o.push(r[h].src);var u=o.length,c=0;0==u?(this._progress=1,this.progressHandle(),this.completeHandle()):s(o,function(t,e){n(new Image).load(function(){i()}).error(function(){i()}).attr("src",e)})},progressHandle:function(){this.trigger(e.PRELOAD_PROGRESS,this.data)},completeHandle:function(){this.trigger(e.PRELOAD_COMPLETE,this.data)},transitionIn:function(){this.resize(),this.trigger(e.TRANSITION_IN,this.data)},transitionInComplete:function(){this.trigger(e.TRANSITION_IN_COMPLETE,this.data)},transitionOut:function(){this.trigger(e.TRANSITION_OUT,this.data)},transitionOutComplete:function(){this.trigger(e.TRANSITION_OUT_COMPLETE,this.data),this.destroy()}}),e});
