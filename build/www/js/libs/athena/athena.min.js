/*!
 * VERSION: 1.5.0
 * DATE: 2016-01-15
 * GIT:https://github.com/shrekshrek/athena-for-mobile
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(t){var e="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["bone","jquery","exports"],function(i,n,s){e.Athena=t(e,s,i,n)});else if("undefined"!=typeof exports){var i=require("bone"),n=require("jquery");t(e,exports,i,n)}else e.Athena=t(e,{},e.Bone,e.jQuery||e.Zepto||e.ender||e.$)}(function(t,e,i,n){function s(t,e){if(void 0===t.length)e.call(t,0,t);else for(var i=t.length,n=0;i>n;n++)e.call(t[n],n,t[n])}function a(t,e){var i=!1;if(A.actionQueue.length){var n=A.actionQueue[A.actionQueue.length-1];s(e,function(e,s){n.action==t&&n.data==s&&(i=!0)})}return i}function r(t){if(!t)throw"page data is undefined!";var e=[];return s(t,function(t,i){"number"==typeof i?i=T[i]:"string"==typeof i&&(i=T[o(i)]);var n=i.data||i;if(!n.depth)throw"page data has wrong!!! must has 'data.depth'";n.depth=o(n.depth),e.push(n)}),e}function o(t){var i=E[2];switch(typeof t){case"string":t=t.toLowerCase();var n="",s=0,a=Math.max(t.indexOf("+"),t.indexOf("-"));switch(a>0?(i=t.substring(0,a),n=t.substring(a,a+1),s=parseInt(t.substring(a+1))):i=t,i){case e.PRELOAD:i=E[0];break;case e.TOP:i=E[1];break;case e.MIDDLE:i=E[2];break;case e.BOTTOM:i=E[3]}switch(n){case"+":i+=s;break;case"-":i-=s}break;case"number":i=Math.floor(t)}return i}i.extend(e,i.Events,{PRELOAD_START:"preloadStart",PRELOAD_PROGRESS:"preloadProgress",PRELOAD_COMPLETE:"preloadComplete",BACKLOAD_COMPLETE:"backloadComplete",TRANSITION_IN:"transitionIn",TRANSITION_IN_COMPLETE:"transitionInComplete",TRANSITION_OUT:"transitionOut",TRANSITION_OUT_COMPLETE:"transitionOutComplete",PRELOAD:"preload",TOP:"top",MIDDLE:"middle",BOTTOM:"bottom",NORMAL:"normal",REVERSE:"reverse",CROSS:"cross",FLOW_START:"flowStart",FLOW_COMPLETE:"flowComplete",WINDOW_RESIZE:"windowResize",PRELOAD_PREPARE:"preloadPrepare"});var u,h,c,l,f=e.NORMAL,d=!1,O={width:0,height:0},p={width:0,height:0},g={width:1,height:1},E=[1500,1e3,500,0],T={},R={},I={},L={},w=null,P=!1,D=!1,A=i.extend({},i.Events,{isFlowing:!1,actionQueue:[],curDatas:null,curIndex:0,curMax:0,pageIn:function(t){this.actionQueue.push({action:"on",data:t}),this.isFlowing||this.playQueue()},pageOut:function(t){this.actionQueue.push({action:"off",data:t}),this.isFlowing||this.playQueue()},playQueue:function(){var t=this;if(0!=this.actionQueue.length){var i=this.actionQueue.shift();switch(this.curDatas=i.data,this.isFlowing=!0,this.curIndex=0,this.curMax=this.curDatas.length,i.action){case"on":s(this.curDatas,function(t,e){A.flowIn(e)});break;case"off":s(this.curDatas,function(i,n){var s=T[n.depth];t.listenToOnce(s,e.TRANSITION_OUT_COMPLETE,function(){A.flowOutComplete(n)}),s.transitionOut()})}e.trigger(e.FLOW_START,this.curDatas)}else this.curDatas=null,this.isFlowing=!1},flowIn:function(t){var i=T[t.depth],n=t.flow||f;switch(n){case e.NORMAL:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){A.flowInComplete(t)}),i.transitionOut()):this.flowInComplete(t);break;case e.PRELOAD:case e.REVERSE:case e.CROSS:this.curIndex++,this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(_,e.PRELOAD_COMPLETE,function(){s(this.curDatas,function(t,e){A.flowInComplete(e)})}),_.load(this.curDatas))}},flowInComplete:function(t){var i=T[t.depth],n=R[t.depth],a=t.flow||f;switch(a){case e.NORMAL:this.curIndex++,this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(_,e.PRELOAD_COMPLETE,function(){s(this.curDatas,function(t,e){A.flowOut(e)})}),_.load(this.curDatas));break;case e.PRELOAD:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){A.flowOut(t)}),i.transitionOut()):this.flowOut(t);break;case e.REVERSE:this.listenToOnce(n,e.TRANSITION_IN_COMPLETE,function(){A.flowOut(t)}),n.transitionIn();break;case e.CROSS:i&&i.transitionOut(),this.flowOut(t)}},flowOut:function(t){var i=T[t.depth],n=R[t.depth],s=t.flow||f;switch(s){case e.NORMAL:case e.PRELOAD:case e.CROSS:this.listenToOnce(n,e.TRANSITION_IN_COMPLETE,function(){A.flowOutComplete(t)}),n.transitionIn();break;case e.REVERSE:i?(this.listenToOnce(i,e.TRANSITION_OUT_COMPLETE,function(){A.flowOutComplete(t)}),i.transitionOut()):this.flowOutComplete(t)}},flowOutComplete:function(t){var i=T[t.depth],n=R[t.depth];i&&delete T[t.depth],n&&(T[t.depth]=n,delete R[t.depth]),t.routing&&(document.title=t.routing),this.curIndex++,this.curIndex>=this.curMax&&(e.trigger(e.FLOW_COMPLETE,this.curDatas),this.playQueue())}}),_=i.extend({},i.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length;var i=this;w?D?(this.listenToOnce(w,e.TRANSITION_IN_COMPLETE,function(){i.preload(t)}),w.transitionIn()):(w.transitionIn(),this.preload(t)):this.preload(t)},preload:function(t){var e=this;s(t,function(t,i){var n=i.depth;if(void 0!=L[n]){m.clearListener(i);var s=L[n];I[n]=s,delete L[n],1!=s._progress?e.initListener(i):e.complete(i)}else require([i.view],function(t){var e=new t({data:i}),n=i;I[n.depth]=e,h.append(e.el),e.init(),_.initListener(n),e.preload(P||"true"===n.fast)})})},initListener:function(t){var i=I[t.depth];this.listenTo(i,e.PRELOAD_PROGRESS,this.progress),this.listenTo(i,e.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var i=I[t.depth];this.stopListening(i,e.PRELOAD_PROGRESS,this.progress),this.stopListening(i,e.PRELOAD_COMPLETE,this.complete)},progress:function(){var t=this,e=0;s(this.curDatas,function(i,n){var s=I[n.depth];s&&(e+=s._progress/t.curMax)}),w&&w.progress({progress:e})},complete:function(t){this.clearListener(t),this.curIndex++,this.curIndex>=this.curMax&&(w&&w.transitionOut(),s(this.curDatas,function(t,e){R[e.depth]=I[e.depth],delete I[e.depth]}),this.curDatas=null,this.trigger(e.PRELOAD_COMPLETE),e.trigger(e.PRELOAD_COMPLETE,this.curDatas))}}),m=i.extend({},i.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){if(this.curDatas)throw"backload is loading!!!";this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length,s(t,function(t,e){require([e.view],function(t){var i=new t({data:e}),n=e;L[n.depth]=i,h.append(i.el),i.init(),m.initListener(n),i.preload(P||"true"===n.fast)})})},initListener:function(t){var i=L[t.depth];this.listenTo(i,e.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var i=L[t.depth];this.stopListening(i,e.PRELOAD_COMPLETE,this.complete)},complete:function(t){this.clearListener(t),this.curIndex++,this.curIndex>=this.curMax&&(this.curDatas=null,this.trigger(e.PRELOAD_COMPLETE),e.trigger(e.BACKLOAD_COMPLETE,this.curDatas))}});return i.extend(e,{init:function(t){h=t||n("body"),u=n("body"),c=n(window),l=n(document),T={},R={},I={},c.resize(function(){e.resize()}),this.resize()},preload:function(t){var e=r(t);m.load(e)},pageTo:function(t){this.pageOn(t)},pageOn:function(t){if(!h)throw"athena havn't stage, must be init!!!";var e=r(t);a("on",e)||A.pageIn(e)},pageOff:function(t){if(!h)throw"athena havn't stage, must be init!!!";var e=r(t);a("off",e)||A.pageOut(e)},calcDepth:function(t){return o(t)},preloader:function(t){if(t){if(!h)throw"athena havn't stage!!!";w&&(w.destroy(),w=null);var i=t.data?t:{data:t};return i.data.depth=o(e.PRELOAD),require([i.data.view],function(t){w=new t(i),h.append(w.el),w.init(),e.trigger(e.PRELOAD_PREPARE)}),w}return w},getPage:function(t){var e=[R,T,I,L];for(var i in e)for(var n in e[i])if(e[i][n].data===t)return e[i][n]},getPageAt:function(t){var e=t?o(t):E[2];return R[e]||T[e]||I[e]||L[e]},fullScreen:function(t){if(t){if("boolean"!=typeof t)throw"setFullScreen params must be bool!!!";d=t,this.resize()}return d},preloadFast:function(t){if(t){if("boolean"!=typeof t)throw"preloadFast params must be bool!!!";P=t}return P},preloadMustIn:function(t){if(t){if("boolean"!=typeof t)throw"preloadMustIn params must be bool!!!";D=t}return D},isFlowing:function(){return A.isFlowing},windowRect:function(){return p},windowRectMin:function(t){return t&&(g.width=t.width||g.width,g.height=t.height||g.height,h.css({"min-width":g.width,"min-height":g.height})),g},stageRect:function(){return O},flow:function(t){var i=f;if(t)switch(t=t.toLowerCase()){case e.NORMAL:case e.PRELOAD:case e.REVERSE:case e.CROSS:i=t}return f=i},resize:function(){p.width=c.width(),p.height=c.height(),d&&h.css({width:p.width,height:p.height}),O.width=h.width(),O.height=h.height(),e.trigger(e.WINDOW_RESIZE)}}),e.Page=i.View.extend({_progress:null,data:null,template:null,initialize:function(t){this.data=t.data,this._progress=0,t.template&&(this.template=t.template,this.render()),this.$el.css({"z-index":this.data.depth})},render:function(){this.$el.html(this.template)},init:function(){this.listenTo(e,e.WINDOW_RESIZE,function(){this.resize()})},resize:function(){},destroy:function(){this.data=null,this.remove()},preload:function(t){function i(){c++,a._progress=c/h,a.progressHandle(),c>=h&&a.completeHandle()}if(this.trigger(e.PRELOAD_START,this.data),t)return void this.completeHandle();for(var a=this,r=this.$el.find("img"),o=[],u=r.length-1;u>=0;u--)r[u].src&&""!==r[u].src&&o.push(r[u].src);var h=o.length,c=0;0==h?(this._progress=1,this.progressHandle(),this.completeHandle()):s(o,function(t,e){n(new Image).load(function(){i()}).error(function(){i()}).attr("src",e)})},progressHandle:function(){this.trigger(e.PRELOAD_PROGRESS,this.data)},completeHandle:function(){this.trigger(e.PRELOAD_COMPLETE,this.data)},transitionIn:function(){this.resize(),this.trigger(e.TRANSITION_IN,this.data)},transitionInComplete:function(){this.trigger(e.TRANSITION_IN_COMPLETE,this.data)},transitionOut:function(){this.trigger(e.TRANSITION_OUT,this.data)},transitionOutComplete:function(){this.trigger(e.TRANSITION_OUT_COMPLETE,this.data),this.destroy()}}),e});
