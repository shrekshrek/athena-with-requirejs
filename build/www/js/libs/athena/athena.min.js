/*!
 * GIT: https://github.com/shrekshrek/athena-with-requirejs
 **/

!function(t,e){if("object"==typeof exports&&"undefined"!=typeof module){var i=require("bone"),n=require("jquery");module.exports=e(i,n)}else"function"==typeof define&&define.amd?define(["bone","jquery"],e):t.Athena=e(t.Bone,t.$)}(this,function(t,e){"use strict";function i(t,e){if(void 0===t.length)e.call(t,0,t);else for(var i=t.length,n=0;n<i;n++)e.call(t[n],n,t[n])}function n(t,e){var n=!1;if(P.actionQueue.length){var s=P.actionQueue[P.actionQueue.length-1];i(e,function(e,i){s.action==t&&s.data==i&&(n=!0)})}return n}function s(t){if(!t)throw"page data is undefined!";var e=[];return i(t,function(t,i){"number"==typeof i?i=g[i]:"string"==typeof i&&(i=g[a(i)]);var n=i.data||i;if(!n.depth)throw"page data has wrong!!! must has 'data.depth'";n.depth=a(n.depth),e.push(n)}),e}function a(t){var e=p[2];switch(typeof t){case"string":t=t.toLowerCase();var i="",n=0,s=Math.max(t.indexOf("+"),t.indexOf("-"));switch(s>0?(e=t.substring(0,s),i=t.substring(s,s+1),n=parseInt(t.substring(s+1))):e=t,e){case u.PRELOAD:e=p[0];break;case u.TOP:e=p[1];break;case u.MIDDLE:e=p[2];break;case u.BOTTOM:e=p[3]}switch(i){case"+":e+=n;break;case"-":e-=n}break;case"number":e=Math.floor(t)}return e}var r,o,h,u=t.extend({},t.Events,{PRELOAD_START:"preloadStart",PRELOAD_PROGRESS:"preloadProgress",PRELOAD_COMPLETE:"preloadComplete",BACKLOAD_COMPLETE:"backloadComplete",TRANSITION_IN:"transitionIn",TRANSITION_IN_COMPLETE:"transitionInComplete",TRANSITION_OUT:"transitionOut",TRANSITION_OUT_COMPLETE:"transitionOutComplete",PRELOAD:"preload",TOP:"top",MIDDLE:"middle",BOTTOM:"bottom",NORMAL:"normal",REVERSE:"reverse",CROSS:"cross",FLOW_START:"flowStart",FLOW_COMPLETE:"flowComplete",WINDOW_RESIZE:"windowResize",PRELOAD_PREPARE:"preloadPrepare"}),c=u.NORMAL,l=!1,d={width:0,height:0},f={width:0,height:0},O={width:1,height:1},p=[1500,1e3,500,0],g={},E={},w={},T={},R=null,L=!1,I=!1,P=t.extend({},t.Events,{isFlowing:!1,actionQueue:[],curDatas:null,curIndex:0,curMax:0,pageIn:function(t){this.actionQueue.push({action:"on",data:t}),this.isFlowing||this.playQueue()},pageOut:function(t){this.actionQueue.push({action:"off",data:t}),this.isFlowing||this.playQueue()},playQueue:function(){var t=this;if(0!=this.actionQueue.length){var e=this.actionQueue.shift();switch(this.curDatas=e.data,this.isFlowing=!0,this.curIndex=0,this.curMax=this.curDatas.length,u.trigger(u.FLOW_START,this.curDatas),e.action){case"on":i(this.curDatas,function(t,e){P.flowIn(e)});break;case"off":i(this.curDatas,function(e,i){var n=g[i.depth];t.listenToOnce(n,u.TRANSITION_OUT_COMPLETE,function(){P.flowOutComplete(i)}),n.transitionOut()})}}else this.curDatas=null,this.isFlowing=!1},flowIn:function(t){var e=g[t.depth];switch(t.flow||c){case u.NORMAL:e?(this.listenToOnce(e,u.TRANSITION_OUT_COMPLETE,function(){P.flowInComplete(t)}),e.transitionOut()):this.flowInComplete(t);break;case u.PRELOAD:case u.REVERSE:case u.CROSS:++this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(v,u.PRELOAD_COMPLETE,function(){i(this.curDatas,function(t,e){P.flowInComplete(e)})}),v.load(this.curDatas))}},flowInComplete:function(t){var e=g[t.depth],n=E[t.depth];switch(t.flow||c){case u.NORMAL:++this.curIndex>=this.curMax&&(this.curIndex=0,this.listenToOnce(v,u.PRELOAD_COMPLETE,function(){i(this.curDatas,function(t,e){P.flowOut(e)})}),v.load(this.curDatas));break;case u.PRELOAD:e?(this.listenToOnce(e,u.TRANSITION_OUT_COMPLETE,function(){P.flowOut(t)}),e.transitionOut()):this.flowOut(t);break;case u.REVERSE:this.listenToOnce(n,u.TRANSITION_IN_COMPLETE,function(){P.flowOut(t)}),n.transitionIn();break;case u.CROSS:e&&e.transitionOut(),this.flowOut(t)}},flowOut:function(t){var e=g[t.depth],i=E[t.depth];switch(t.flow||c){case u.NORMAL:case u.PRELOAD:case u.CROSS:this.listenToOnce(i,u.TRANSITION_IN_COMPLETE,function(){P.flowOutComplete(t)}),i.transitionIn();break;case u.REVERSE:e?(this.listenToOnce(e,u.TRANSITION_OUT_COMPLETE,function(){P.flowOutComplete(t)}),e.transitionOut()):this.flowOutComplete(t)}},flowOutComplete:function(t){var e=g[t.depth],i=E[t.depth];e&&delete g[t.depth],i&&(g[t.depth]=i,delete E[t.depth]),t.routing&&(document.title=t.routing),++this.curIndex>=this.curMax&&(u.trigger(u.FLOW_COMPLETE,this.curDatas),this.playQueue())}}),v=t.extend({},t.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length;var e=this;R?I?(this.listenToOnce(R,u.TRANSITION_IN_COMPLETE,function(){e.preload(t)}),R.transitionIn()):(R.transitionIn(),this.preload(t)):this.preload(t)},preload:function(t){var e=this;i(t,function(t,i){var n=i.depth;if(void 0!=T[n]){D.clearListener(i);var s=T[n];w[n]=s,delete T[n],1!=s._progress?e.initListener(i):e.complete(i)}else require([i.view],function(t){var e=new t({data:i}),n=i;w[n.depth]=e,r.append(e.el),e.init(),v.initListener(n),e.preload(L||"true"===n.fast)})})},initListener:function(t){var e=w[t.depth];this.listenTo(e,u.PRELOAD_PROGRESS,this.progress),this.listenTo(e,u.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var e=w[t.depth];this.stopListening(e,u.PRELOAD_PROGRESS,this.progress),this.stopListening(e,u.PRELOAD_COMPLETE,this.complete)},progress:function(){var t=this,e=0;i(this.curDatas,function(i,n){var s=w[n.depth];s&&(e+=s._progress/t.curMax)}),R&&R.progress({progress:e})},complete:function(t){this.clearListener(t),++this.curIndex>=this.curMax&&(R&&R.transitionOut(),i(this.curDatas,function(t,e){E[e.depth]=w[e.depth],delete w[e.depth]}),this.curDatas=null,this.trigger(u.PRELOAD_COMPLETE),u.trigger(u.PRELOAD_COMPLETE,this.curDatas))}}),D=t.extend({},t.Events,{curDatas:null,curIndex:0,curMax:0,load:function(t){if(this.curDatas)throw"backload is loading!!!";this.curDatas=t,this.curIndex=0,this.curMax=this.curDatas.length,i(t,function(t,e){require([e.view],function(t){var i=new t({data:e}),n=e;T[n.depth]=i,r.append(i.el),i.init(),D.initListener(n),i.preload(L||"true"===n.fast)})})},initListener:function(t){var e=T[t.depth];this.listenTo(e,u.PRELOAD_COMPLETE,this.complete)},clearListener:function(t){var e=T[t.depth];this.stopListening(e,u.PRELOAD_COMPLETE,this.complete)},complete:function(t){this.clearListener(t),++this.curIndex>=this.curMax&&(this.curDatas=null,this.trigger(u.PRELOAD_COMPLETE),u.trigger(u.BACKLOAD_COMPLETE,this.curDatas))}}),_=t.extend({},{load:function(t){function e(){u++,a(u/h),u>=h&&s()}for(var n=t.data,s=t.complete,a=t.progress,r=[],o=n.length-1;o>=0;o--)n[o].src&&""!==n[o].src&&"data:"!==n[o].src.substr(0,5)&&r.push(n[o].src);var h=r.length,u=0;0==h?s():i(r,function(t,i){var n=new Image;n.onload=n.onerror=function(){e()},n.src=i})}});return t.extend(u,{init:function(t){r=t||e("body"),o=e(window),h=e(document),g={},E={},w={},o.on("resize",function(){u.resize()}),this.resize()},preload:function(t){var e=s(t);D.load(e)},pageTo:function(t){this.pageOn(t)},pageOn:function(t){if(!r)throw"athena havn't stage, must be init!!!";var e=s(t);n("on",e)||P.pageIn(e)},pageOff:function(t){if(!r)throw"athena havn't stage, must be init!!!";var e=s(t);n("off",e)||P.pageOut(e)},calcDepth:function(t){return a(t)},preloader:function(t){if(t){if(!r)throw"athena havn't stage!!!";R&&(R.destroy(),R=null);var e=t.data?t:{data:t};return e.data.depth=a(u.PRELOAD),require([e.data.view],function(t){R=new t(e),r.append(R.el),R.init(),u.trigger(u.PRELOAD_PREPARE)}),R}return R},getPage:function(t){var e=[E,g,w,T];for(var i in e)for(var n in e[i])if(e[i][n].data===t)return e[i][n]},getPageAt:function(t){var e=t?a(t):p[2];return E[e]||g[e]||w[e]||T[e]},fullScreen:function(t){if(t){if("boolean"!=typeof t)throw"setFullScreen params must be bool!!!";l=t,this.resize()}return l},preloadFast:function(t){if(t){if("boolean"!=typeof t)throw"preloadFast params must be bool!!!";L=t}return L},preloadMustIn:function(t){if(t){if("boolean"!=typeof t)throw"preloadMustIn params must be bool!!!";I=t}return I},isFlowing:function(){return P.isFlowing},windowRect:function(){return f},windowRectMin:function(t){return t&&(O.width=t.width||O.width,O.height=t.height||O.height),O},stageRect:function(){return d},flow:function(t){var e=c;if(t)switch(t=t.toLowerCase()){case u.NORMAL:case u.PRELOAD:case u.REVERSE:case u.CROSS:e=t}return c=e},resize:function(){f.width=o.width(),f.height=o.height(),l?(f.width<O.width?r.css("overflow-x","auto"):r.css("overflow-x","hidden"),f.height<O.height?r.css("overflow-y","auto"):r.css("overflow-y","hidden"),f.width=o.width(),f.height=o.height(),d.width=Math.max(f.width,O.width),d.height=Math.max(f.height,O.height),r.width(d.width),r.height(d.height)):(r.css("overflow","auto"),f.width=o.width(),f.height=o.height(),d.width=h.width(),d.height=h.height()),u.trigger(u.WINDOW_RESIZE)}}),u.Page=t.View.extend({_progress:null,data:null,template:null,initialize:function(t){this.data=t.data,this._progress=0,t.template&&(this.template=t.template,this.render()),this.$el.css({"z-index":this.data.depth})},render:function(){this.$el.html(this.template)},init:function(){this.listenTo(u,u.WINDOW_RESIZE,function(){this.resize()})},resize:function(){},destroy:function(){this.data=null,this.remove()},preload:function(t){if(this.trigger(u.PRELOAD_START,this.data),t)return void this.completeHandle();var e=this;_.load({data:this.$el.find("img"),progress:function(t){e._progress=t,e.progressHandle()},complete:function(){e._progress=1,e.completeHandle()}})},progressHandle:function(){this.trigger(u.PRELOAD_PROGRESS,this.data)},completeHandle:function(){this.trigger(u.PRELOAD_COMPLETE,this.data)},transitionIn:function(){this.resize(),this.trigger(u.TRANSITION_IN,this.data)},transitionInComplete:function(){this.trigger(u.TRANSITION_IN_COMPLETE,this.data)},transitionOut:function(){this.trigger(u.TRANSITION_OUT,this.data)},transitionOutComplete:function(){this.trigger(u.TRANSITION_OUT_COMPLETE,this.data),this.destroy()}}),u});
