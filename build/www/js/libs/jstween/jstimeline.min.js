/*!
 * VERSION: 0.9.0
 * DATE: 2017-9-3
 * GIT: https://github.com/shrekshrek/jstween
 * @author: Shrek.wang
 **/

!function(e){if("function"==typeof define&&define.amd)define(["jstween","exports"],function(i,t){window.JTL=e(t,i)});else if("undefined"!=typeof exports){var i=require("jstween");e(exports,i)}else window.JTL=e({},window.JT)}(function(e,i){function t(e,i){for(var t in i)e[t]=i[t]}function s(e){var i=/(^[a-zA-Z]\w*|)(\+=|-=|)(\d*\.\d*|\d*)/,t=i.exec(e);return{label:t[1],ext:t[2],num:parseFloat(t[3])}}function n(){var e=a.length;if(0===e)return void(o=!1);var t=i.now(),s=t-u;u=t,m=a.slice(0);for(var h=0;e>h;h++){var c=m[h];c&&c.isPlaying&&!c._update(s)&&c.pause()}r(n)}function h(){this.initialize.apply(this,arguments)}var r=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},a=[],m=[],o=!1,u=0;return t(h.prototype,{initialize:function(e){this.endTime=0,this.labels=[],this.tweens=[],this.calls=[],this.isPlaying=!1,this.isReverse=e&&e.isReverse||!1,this.timeScale=e&&e.timeScale||1,this.isKeep=!1,this.curTime=this.prevTime=0},_update:function(e){return this.isKeep=!1,e=this.isReverse?-e*this.timeScale:e*this.timeScale,this.prevTime=this.curTime,this.curTime=this.prevTime+e,this.isReverse&&this.prevTime>=0&&this.curTime<0?(this.curTime=0,this._checkCall(),this._checkTween(),this.isKeep):!this.isReverse&&this.prevTime<this.endTime&&this.curTime>=this.endTime?(this.curTime=this.endTime,this._checkCall(),this._checkTween(),this.isKeep):(this._checkCall(),this._checkTween(),!0)},_addSelf:function(){a.push(this),o||(u=i.now(),o=!0,r(n))},_removeSelf:function(){var e=a.indexOf(this);-1!==e&&a.splice(e,1)},_parsePosition:function(e){if(void 0==e)return this.endTime;var i=s(e),t=0;if(i.label)t=this.getLabelTime(i.label);else if(i.ext)switch(i.ext){case"+=":t=this.endTime+1e3*i.num;break;case"-=":t=this.endTime-1e3*i.num}else i.num&&(t=1e3*i.num);return t},_addCall:function(e,i){var t=this._parsePosition(i);this.endTime=Math.max(this.endTime,t),this.calls.push({time:t,call:e})},_checkCall:function(){for(var e=0,i=this.calls.length;i>e;e++){var t=this.calls[e],s=t.time;(this.isReverse?this.prevTime>=s&&this.curTime<s:this.prevTime<s&&this.curTime>=s)&&t.call()}},_addTween:function(e,i){var t=this._parsePosition(i);this.endTime=Math.max(this.endTime,t+e.endTime),this.tweens.push({time:t,tween:e})},_checkTween:function(){for(var e=0,i=this.tweens.length;i>e;e++){var t=this.tweens[e],s=t.time,n=t.time+t.tween.endTime;(this.curTime>=s&&this.curTime<=n||this.prevTime>s&&this.prevTime<n)&&(this.prevTime>=s&&this.curTime<s?t.tween._update(this.prevTime-s):this.prevTime>n&&this.curTime<=n?(t.tween.curTime=t.tween.prevTime=t.tween.endTime,t.tween._update(n-this.curTime)):this.prevTime<s&&this.curTime>=s?(t.tween.curTime=t.tween.prevTime=0,t.tween._update(this.curTime-s)):t.tween._update(this.prevTime<=n&&this.curTime>n?n-this.prevTime:Math.abs(this.curTime-this.prevTime)))}},fromTo:function(e,t,s,n,h){n.isPlaying=!1;var r=i.fromTo(e,t,s,n);return this._addTween(r,h),this},from:function(e,t,s,n){s.isPlaying=!1;var h=i.from(e,t,s);return this._addTween(h,n),this},to:function(e,t,s,n){s.isPlaying=!1;var h=i.to(e,t,s);return this._addTween(h,n),this},add:function(e,i){switch(typeof e){case"object":this._addTween(e,i);break;case"function":this._addCall(e,i);break;case"string":this.addLabel(e,i);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);this.labels.push({name:e,time:t})},removeLabel:function(e){for(var i=0,t=this.labels.length;t>i;i++){var s=this.labels[i];if(e==s.name)return void this.labels.splice(i,1)}},getLabelTime:function(e){for(var i=0,t=this.labels.length;t>i;i++){var s=this.labels[i];if(e==s.name)return s.time}return this.endTime},totalTime:function(){return this.endTime},play:function(e){this.isKeep=!0,this.isReverse=!1;for(var i in this.tweens)this.tweens[i].tween.isReverse=this.isReverse;void 0!==e&&this.seek(e),this.isPlaying||(this.isPlaying=!0,this._addSelf())},pause:function(){this.isKeep=!1,this.isPlaying&&(this.isPlaying=!1,this._removeSelf())},stop:function(){this.pause(),this.curTime=this.prevTime=0},reverse:function(e){this.isKeep=!0,this.isReverse=!0;for(var i in this.tweens)this.tweens[i].tween.isReverse=this.isReverse;void 0!==e&&this.seek(e),this.isPlaying||(this.isPlaying=!0,this._addSelf())},seek:function(e){this.curTime=this.prevTime=this._parsePosition(e);for(var i=0,t=this.tweens.length;t>i;i++){var s=this.tweens[i],n=s.time,h=s.time+s.tween.endTime;(this.curTime>=n&&this.curTime<=h||this.prevTime>n&&this.prevTime<h)&&s.tween.seek((this.curTime-n)/1e3)}},kill:function(){this.pause(),this.tweens=[],this.calls=[],this.labels=[],this.endTime=0,this.curTime=this.prevTime=0}}),t(e,{create:function(){return new h},kill:function(e){e.kill()}}),e});
