/*!
 * VERSION: 0.3.0
 * DATE: 2016-8-17
 * GIT:https://github.com/shrekshrek/jstween
 *
 * @author: Shrek.wang, shrekshrek@gmail.com
 **/

!function(e){var i="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["jstween","exports"],function(t,n){i.JTL=e(i,n,t)});else if("undefined"!=typeof exports){var t=require("jstween");e(i,exports,t)}else i.JTL=e(i,{},i.JT)}(function(e,i,t){function n(e,i){for(var t in i)e[t]=i[t]}function s(e){var i=/(^[a-zA-Z]\w*|)(\+=|-=|)(\d*\.\d*|\d*)/,t=i.exec(e);return{label:t[1],ext:t[2],num:parseFloat(t[3])}}function a(){l=!0;var e=o.length;if(0===e)return void(l=!1);var i=t.now(),n=i-c;c=i;for(var s=e-1;s>=0;s--)o[s]._update(n);h(a)}function r(){this.initialize.apply(this,arguments)}var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},o=[],l=!1,c=0;return n(r.prototype,{initialize:function(){this.labels=[],this.labelTime=0,this.anchors=[],this.anchorId=0,this.tweens=[],this.isPlaying=!1,this.curTime=0},_update:function(e){this.isPlaying&&(this.curTime+=e,this._checkHandler())},_addSelf:function(){o.push(this),l||(c=t.now(),a())},_removeSelf:function(){var e=o.indexOf(this);-1!==e&&o.splice(e,1)},_checkHandler:function(){var e=this.anchors.length;if(this.anchorId>=e)return this._removeSelf(),void(this.isPlaying=!1);var i=this.anchors[this.anchorId];this.curTime>=1e3*i.time&&(this.anchorId==e-1?(this._removeSelf(),this.isPlaying=!1,i.handler.apply()):(i.handler.apply(),this.anchorId++,this._checkHandler()))},_parseTweenTime:function(e,i,t){var n=Math.max(e,0),s=Math.max(i.delay||0,0),a=Math.max(0,Math.floor(i.repeat||0)),r=Math.max(i.repeatDelay||0,0),h=s+n+(r+n)*a,o=this._parsePosition(t);return this.labelTime=Math.max(this.labelTime,o+h),o},_parsePosition:function(e){if(void 0==e)return this.labelTime;var i=s(e),t=0;if(i.label)switch(t=this.getLabelTime(i.label),i.ext){case"+=":t+=i.num;break;case"-=":t-=i.num}else t=i.num;return t},_addAnchor:function(e,i){var t=this.anchors.length;if(0==t)return void this.anchors.push({time:i,handler:e});if(t>0)for(var n=t-1;n>=0;n--){var s=this.anchors[n];if(i>=s.time)return void this.anchors.splice(n+1,0,{time:i,handler:e})}},_addTween:function(e){if(void 0!=e.length)for(var i in e)this.tweens.push(e[i]);else this.tweens.push(e)},_removeTween:function(e){var i=this.tweens.indexOf(e);-1!==i&&this.tweens.splice(i,1)},fromTo:function(e,i,n,s,a){var r=this,h=s.onEnd;s.onEnd=function(e){r._removeTween(this),h&&h.apply(this,e)};var o=function(){var a=t.fromTo(e,i,n,s);r._addTween(a)},l=this._parseTweenTime(i,s,a);return this._addAnchor(o,l),this},from:function(e,i,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=t.from(e,i,n);a._addTween(s)},o=this._parseTweenTime(i,n,s);return this._addAnchor(h,o),this},to:function(e,i,n,s){var a=this,r=n.onEnd;n.onEnd=function(e){a._removeTween(this),r&&r.apply(this,e)};var h=function(){var s=t.to(e,i,n);a._addTween(s)},o=this._parseTweenTime(i,n,s);return this._addAnchor(h,o),this},kill:function(e,i){var n=function(){t.kill(e,!0)},s=this._parseTweenTime(0,{},i);return this._addAnchor(n,s),this},add:function(e,i){var t=this._parsePosition(i);switch(typeof e){case"function":this._addAnchor(e,t);break;case"string":this.addLabel(e,t);break;default:throw"add action is wrong!!!"}return this},addLabel:function(e,i){this.removeLabel(e);var t=this._parsePosition(i);return this.labels.push({name:e,time:t}),this},removeLabel:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return this.labels.splice(t,1),this}return this},getLabelTime:function(e){for(var i=this.labels.length,t=i-1;t>=0;t--){var n=this.labels[t];if(e==n.name)return n.time}return this.labelTime},totalTime:function(){return this.labelTime},play:function(e){this.isPlaying&&this.pause();for(var i=this.tweens.length,t=i-1;t>=0;t--)this.tweens[t].play();this._addSelf(),this.isPlaying=!0,void 0!==e&&this.seek(e)},pause:function(){if(this.isPlaying){for(var e=this.tweens.length,i=e-1;i>=0;i--)this.tweens[i].pause();this._removeSelf(),this.isPlaying=!1}},seek:function(e){var i=this._parsePosition(e);this.curTime=1e3*i;for(var t=this.anchors.length,n=0;t>n;n++){var s=this.anchors[n];if(1e3*s.time>=this.curTime)return void(this.anchorId=n)}},clear:function(){for(var e=this.tweens.length,i=e-1;i>=0;i--)this.tweens[i].kill();this.tweens=[],this.curTime=0,this.labels=[],this.labelTime=0,this.anchors=[],this.anchorId=0}}),n(i,{create:function(){return new r},kill:function(e){e.clear()}}),i});
